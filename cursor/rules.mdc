name: NorthPadel Backend Context
description: Aplica siempre las reglas de arquitectura, seguridad y estilo para el backend del proyecto NorthPadel.
trigger: always
mode: append

üîß NorthPadel Backend ‚Äì Contexto y Reglas

Antes de ejecutar cualquier acci√≥n en la carpeta del backend, el agente debe consultar, entender y respetar √≠ntegramente las reglas y la arquitectura definidas en este documento. Este archivo es la fuente de verdad absoluta para el desarrollo del servidor.

Checklist de Validaci√≥n de Entrega (Backend)

Toda entrega de c√≥digo para el backend DEBE ser validada contra los siguientes puntos sin excepci√≥n:

Seguridad de Rutas: Toda ruta que no sea p√∫blica (como el login o registro) DEBE estar protegida por el middleware protect.

Validaci√≥n de Entradas: Toda ruta que reciba datos en el req.body (ej: POST, PUT) DEBE usar el middleware validate con un esquema de Joi.

Manejo de Contrase√±as: Las contrase√±as NUNCA deben ser guardadas o comparadas en texto plano. Se DEBE usar bcryptjs.

Estructura de Carpetas: El c√≥digo DEBE estar organizado en las carpetas designadas (routes, middlewares, validators, config).

Manejo de Errores: Toda la l√≥gica as√≠ncrona dentro de un endpoint DEBE estar envuelta en un bloque try/catch para prevenir que el servidor se cierre por un error inesperado.

Si no se puede cumplir con alguna de estas condiciones, el agente debe detenerse y solicitar clarificaci√≥n.

1. Visi√≥n General del Backend

Stack Tecnol√≥gico: Node.js, Express.js.

Base de Datos: Google Firebase Firestore, a trav√©s del SDK firebase-admin.

Autenticaci√≥n: Basada en Tokens JWT (JSON Web Tokens).

2. üèõÔ∏è Arquitectura y Estructura de Carpetas

La organizaci√≥n del c√≥digo es estricta para mantener la modularidad y claridad.

index.js: Es el punto de entrada. Su √∫nica responsabilidad es:

Cargar variables de entorno.

Inicializar la conexi√≥n a Firebase (importando desde /config).

Configurar middlewares globales (como cors y express.json).

Registrar los enrutadores principales (ej: app.use('/api/auth', authRoutes)).

Iniciar el servidor.

config/: Conecta y exporta instancias de servicios externos. El archivo principal es firebase.js.

routes/: Define los endpoints de la API. Debe haber un archivo por cada entidad principal (ej: auth.js, canchas.js, reservas.js, admin.js). Cada archivo debe exportar un express.Router().

middlewares/: Contiene funciones que se ejecutan antes de la l√≥gica del endpoint. Archivos clave:

authMiddleware.js: Contiene la funci√≥n protect para verificar el token JWT.

validate.js: Contiene el middleware gen√©rico para la validaci√≥n con Joi.

validators/: Contiene los esquemas de validaci√≥n de Joi. Cada entidad con validaci√≥n debe tener su propio archivo (ej: authValidator.js).

3. üîê Seguridad (Reglas Cr√≠ticas e Inquebrantables)

Protecci√≥n de Rutas (Middleware protect):

Se importa desde middlewares/authMiddleware.js.

Se aplica a cualquier ruta que requiera que un usuario est√© autenticado.

Ejemplo: router.get('/reservas', protect, async (req, res) => { ... });

El middleware protect a√±ade un objeto req.user a la petici√≥n con los datos del token (userId, role).

Manejo de Contrase√±as (bcryptjs):

Registro: La contrase√±a del req.body DEBE ser hasheada con bcrypt.hash() antes de ser guardada en Firestore.

Login: La contrase√±a del req.body DEBE ser verificada contra el hash de la base de datos usando bcrypt.compare().

Validaci√≥n de Entradas (Joi):

Los esquemas se definen en la carpeta /validators.

El middleware validate se importa desde middlewares/validate.js.

Se aplica a toda ruta que reciba datos (POST, PUT).

Ejemplo: router.post('/register', validate(registerSchema), async (req, res) => { ... });

Autenticaci√≥n por Tokens (jsonwebtoken):

El endpoint de login (POST /api/auth/login) es el √∫nico lugar donde se debe generar un token JWT usando jwt.sign().

El secreto del token (JWT_SECRET) debe ser manejado como una variable de entorno